<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400&display=swap" rel="stylesheet">

<div style="text-align:center; margin:1em 0;">
  <button id="omikujiBtn" onclick="drawOmikuji()">Draw Omikuji</button>
</div>

<div id="resultContainer" class="result-container">
  <div id="fortuneImgWrapper" class="fortune-img-wrapper">
    <img id="fortuneImg" src="" alt="" class="fortune-img">
  </div>
  <pre id="output" class="fortune-text"></pre>
</div>

<style>
body {
  font-family: 'Noto Serif JP', serif;
}
#omikujiBtn {
  background: #b30000;
  border: 2px solid #ffd700;
  border-radius: 12px;
  padding: 12px 24px;
  color: #ffd700;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}
#omikujiBtn:hover { background: #cc0000; }
#omikujiBtn:active { background: #990000; }

.result-container {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  flex-wrap: wrap;
  gap: 32px;
  margin-top: 40px;
  text-align: left;
}

.fortune-img-wrapper {
  width: clamp(220px, 30vw, 280px);
  max-width: 100%;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.fortune-img {
  display: block;
  width: 100%;               /* fills wrapper exactly */
  height: auto;              /* keeps aspect ratio */
  object-fit: contain;
  border-radius: 8px;
  flex-shrink: 0;        /* never shrink when text appears */
  visibility: hidden;
}

.fortune-text {
  white-space: pre-wrap;
  font-size: 18px;
  line-height: 1.5;
  width: 400px;
}

/* mobile responsiveness */
@media (max-width: 640px) {
  .result-container {
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-top: 20px;
  }

  .fortune-img-wrapper {
    width: min(90vw, 280px);
  }

  .fortune-img {
    margin: 0 auto;     /* center while stacked */
  }

  .fortune-text {
    width: min(90vw, 400px);
    min-height: 250px;
    text-align: left;
  }
}
</style>

<script>
const omikujiList = [
  { name: "Great Blessing (Â§ßÂêâ)", prob: 0.10, img: "./images/omk_1.png" },
  { name: "Middle Blessing (‰∏≠Âêâ)", prob: 0.15, img: "./images/omk_2.png" },
  { name: "Small Blessing (Â∞èÂêâ)", prob: 0.20, img: "./images/omk_3.png" },
  { name: "Blessing (Âêâ)", prob: 0.24, img: "./images/omk_4.png" },
  { name: "Half-blessing (ÂçäÂêâ)", prob: 0.05, img: "./images/omk_5.png" },
  { name: "Future Blessing (Êú´Âêâ)", prob: 0.10, img: "./images/omk_6.png" },
  { name: "Curse (Âá∂)", prob: 0.10, img: "./images/omk_7.png" },
  { name: "Great Curse (Â§ßÂá∂)", prob: 0.05, img: "./images/omk_8.png" },
  { name: "Catastrophe (Â§ßÊÉ®‰∫ã)", prob: 0.01, img: "./images/omk_9.png" }
];

const categories = {
  "General": [
    "An excellent day for new beginnings",
    "Stay cautious but optimistic",
    "A calm and steady day",
    "Small joys await you",
    "Mild progress; keep your focus",
    "Better things are coming",
    "Beware of missteps",
    "A challenging day‚Äîbe resilient",
    "Disaster stalks from afar"
  ],
  "Work & Studies": [
    "Success through effort","Steady gains","Good focus needed","Don‚Äôt procrastinate",
    "Progress will be slow","Delays expected","Mistakes likely","Consider a new approach","One slip undoes much"
  ],
  "Finances": [
    "Fortune favors you","Steady inflow","Watch your spending","Moderation is key",
    "Avoid big purchases","Wait before investing","Be frugal","High risk‚Äîavoid speculation","Loss strikes hard"
  ],
  "Relationships": [
    "Strong bonds deepen","Warm connections grow","Good communication helps","Moments of affection",
    "Keep expectations low","Patience is needed","Misunderstandings ahead","Distance may arise","Expect discord"
  ],
  "Health": [
    "Vital and strong","Feeling well","Take breaks","Eat carefully","Don't neglect rest",
    "Slight concerns","Fatigue likely","Watch for illness","Misfortune waylays strength"
  ]
};

const luckySymbols = {
  "Item": ["Bell","Coin","Sakura charm","Lantern","Cat figurine","Bamboo leaf","Money mallet","Sake cup","Koi"],
  "Direction": ["North","East","South","West","Northeast","Southwest"],
  "Time": ["Morning","Afternoon","Evening","Late night"]
};

// new category
const suggestedActivities = [
  "Schedule a meeting with a mentor",
  "Eat Japanese food",
  "Go home and rest",
  "Find a change of scenery",
  "Compose a haiku",
  "Explore nature",
  "Photograph symmetry",
  "Search for Shiba Inu"
];

function weightedRandomIndex(list) {
  const r = Math.random();
  let cum = 0;
  for (let i = 0; i < list.length; i++) {
    cum += list[i].prob;
    if (r < cum) return i;
  }
  return list.length - 1;
}

function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function drawOmikuji() {
  const btn = document.getElementById("omikujiBtn");
  btn.disabled = true;                                 // disable button
  const idx = weightedRandomIndex(omikujiList);
  const fortune = omikujiList[idx];
  const out = document.getElementById("output");
  const img = document.getElementById("fortuneImg");

  out.textContent = "";

// hide current image immediately
img.style.visibility = "hidden";

// reset wrapper height so we don't momentarily keep the old image's height
const wrapper = document.getElementById("fortuneImgWrapper");
wrapper.style.height = "";

// set up handler to size wrapper and reveal image only when fully loaded
img.onload = () => {
  const scale = img.clientWidth / img.naturalWidth;
  const renderedHeight = img.naturalHeight * scale;
  wrapper.style.height = `${renderedHeight}px`;
  img.style.visibility = "visible";
};

// set the new source (this triggers the load event)
img.src = fortune.img;
img.alt = fortune.name;

  let delay = 1000;

  // Longer pause before showing "Your Omikuji"
  delay += 800;
  setTimeout(() => {
    out.textContent += `üé¥ Your Omikuji: ${fortune.name}\n\n`;
  }, delay);
  delay += 1500; // extra pause after

  for (const [cat, arr] of Object.entries(categories)) {
    setTimeout(() => {
      out.textContent += `${cat}: ${arr[idx]}\n`;
    }, delay);
    delay += 600;
  }

  // Longer pause before "Lucky Symbols"
  delay += 800;
  setTimeout(() => {
    out.textContent += `\nüçÄ Lucky Symbols:\n`;
  }, delay);
  delay += 1500; // extra pause after header

  for (const [k, v] of Object.entries(luckySymbols)) {
    setTimeout(() => {
      out.textContent += `${k}: ${randomChoice(v)}\n`;
    }, delay);
    delay += 600;
  }

  // Add suggested activity at the end
  delay += 800;
  setTimeout(() => {
    out.textContent += `\nüéå Suggested Activity:\n`;
  }, delay);
  delay += 1000;
  setTimeout(() => {
    out.textContent += `${randomChoice(suggestedActivities)}\n`;
  }, delay);

  setTimeout(() => {
    btn.disabled = false;
  }, delay + 500);
}
</script>
